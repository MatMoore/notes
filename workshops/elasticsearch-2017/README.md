# Elasticsearch workshop

This repository contains some resources for a workshop I ran in 2017, to help explain how [GOV.UK's search function](https://github.com/alphagov/rummager) works, and what this monsterous Elasticsearch query is doing:

```json
{
   "query":{
      "function_score":{
         "boost_mode":"multiply",
         "query":{
            "function_score":{
               "boost_mode":"multiply",
               "score_mode":"multiply",
               "query":{
                  "bool":{
                     "should":[
                        {
                           "bool":{
                              "should":[
                                 {
                                    "match_phrase":{
                                       "title.synonym":{
                                          "query":"penguins",
                                          "analyzer":"with_search_synonyms"
                                       }
                                    }
                                 },
                                 {
                                    "match_phrase":{
                                       "acronym.synonym":{
                                          "query":"penguins",
                                          "analyzer":"with_search_synonyms"
                                       }
                                    }
                                 },
                                 {
                                    "match_phrase":{
                                       "description.synonym":{
                                          "query":"penguins",
                                          "analyzer":"with_search_synonyms"
                                       }
                                    }
                                 },
                                 {
                                    "match_phrase":{
                                       "indexable_content.synonym":{
                                          "query":"penguins",
                                          "analyzer":"with_search_synonyms"
                                       }
                                    }
                                 },
                                 {
                                    "multi_match":{
                                       "query":"penguins",
                                       "operator":"and",
                                       "fields":[
                                          "title.synonym",
                                          "acronym.synonym",
                                          "description.synonym",
                                          "indexable_content.synonym"
                                       ],
                                       "analyzer":"with_search_synonyms"
                                    }
                                 },
                                 {
                                    "multi_match":{
                                       "query":"penguins",
                                       "operator":"or",
                                       "fields":[
                                          "title.synonym",
                                          "acronym.synonym",
                                          "description.synonym",
                                          "indexable_content.synonym"
                                       ],
                                       "analyzer":"with_search_synonyms"
                                    }
                                 },
                                 {
                                    "match":{
                                       "all_searchable_text.synonym":{
                                          "query":"penguins",
                                          "analyzer":"with_search_synonyms",
                                          "minimum_should_match":"2\u003c2 3\u003c3 7\u003c50%"
                                       }
                                    }
                                 }
                              ]
                           }
                        }
                     ]
                  }
               },
               "functions":[
                  {
                     "filter":{
                        "term":{
                           "format":"service_manual_guide"
                        }
                     },
                     "boost_factor":0.3
                  },
                  {
                     "filter":{
                        "term":{
                           "format":"service_manual_topic"
                        }
                     },
                     "boost_factor":0.3
                  },
                  {
                     "filter":{
                        "term":{
                           "format":"transaction"
                        }
                     },
                     "boost_factor":1.5
                  },
                  {
                     "filter":{
                        "term":{
                           "format":"aaib_report"
                        }
                     },
                     "boost_factor":0.2
                  },
                  {
                     "filter":{
                        "term":{
                           "format":"dfid_research_output"
                        }
                     },
                     "boost_factor":0.2
                  },
                  {
                     "filter":{
                        "term":{
                           "format":"hmrc_manual_section"
                        }
                     },
                     "boost_factor":0.2
                  },
                  {
                     "filter":{
                        "term":{
                           "format":"service_standard_report"
                        }
                     },
                     "boost_factor":0.05
                  },
                  {
                     "filter":{
                        "term":{
                           "format":"contact"
                        }
                     },
                     "boost_factor":0.3
                  },
                  {
                     "filter":{
                        "term":{
                           "format":"document_collection"
                        }
                     },
                     "boost_factor":1.3
                  },
                  {
                     "filter":{
                        "term":{
                           "format":"document_series"
                        }
                     },
                     "boost_factor":1.3
                  },
                  {
                     "filter":{
                        "term":{
                           "format":"minister"
                        }
                     },
                     "boost_factor":1.7
                  },
                  {
                     "filter":{
                        "term":{
                           "format":"operational_field"
                        }
                     },
                     "boost_factor":1.5
                  },
                  {
                     "filter":{
                        "term":{
                           "format":"organisation"
                        }
                     },
                     "boost_factor":2.5
                  },
                  {
                     "filter":{
                        "term":{
                           "format":"topic"
                        }
                     },
                     "boost_factor":1.5
                  },
                  {
                     "filter":{
                        "term":{
                           "format":"topical_event"
                        }
                     },
                     "boost_factor":1.5
                  },
                  {
                     "filter":{
                        "term":{
                           "format":"mainstream_browse_page"
                        }
                     },
                     "boost_factor":0
                  },
                  {
                     "filter":{
                        "term":{
                           "format":"specialist_sector"
                        }
                     },
                     "boost_factor":2.5
                  },
                  {
                     "filter":{
                        "term":{
                           "content_store_document_type":"foi_release"
                        }
                     },
                     "boost_factor":0.2
                  },
                  {
                     "filter":{
                        "term":{
                           "navigation_document_supertype":"guidance"
                        }
                     },
                     "boost_factor":2.5
                  },
                  {
                     "filter":{
                        "term":{
                           "search_user_need_document_supertype":"core"
                        }
                     },
                     "boost_factor":1.5
                  },
                  {
                     "filter":{
                        "term":{
                           "organisation_state":"closed"
                        }
                     },
                     "boost_factor":0.2
                  },
                  {
                     "filter":{
                        "term":{
                           "organisation_state":"devolved"
                        }
                     },
                     "boost_factor":0.3
                  },
                  {
                     "filter":{
                        "term":{
                           "is_historic":true
                        }
                     },
                     "boost_factor":0.5
                  },
                  {
                     "filter":{
                        "term":{
                           "search_format_types":"announcement"
                        }
                     },
                     "script_score":{
                        "script":"((0.05 / ((3.16*pow(10,-11)) * abs(now - doc['public_timestamp'].date.getMillis()) + 0.05)) + 0.12)",
                        "params":{
                           "now":1532769780000
                        }
                     }
                  }
               ]
            }
         },
         "script_score":{
            "script":"doc['popularity'].value + 0.001"
         }
      }
   },
   "filter":{
      "indices":{
         "indices":[
            "detailed",
            "government"
         ],
         "filter":{
            "bool":{
               "should":[
                  {
                     "bool":{
                        "must_not":{
                           "term":{
                              "is_withdrawn":true
                           }
                        }
                     }
                  }
               ],
               "must_not":{
                  "terms":{
                     "format":[
                        "mainstream_browse_page",
                        "specialist_sector",
                        "contact",
                        "answer",
                        "guide",
                        "help_page",
                        "licence",
                        "local_transaction",
                        "place",
                        "transaction",
                        "simple_smart_answer",
                        "aaib_report",
                        "asylum_support_decision",
                        "business_finance_support_scheme",
                        "cma_case",
                        "countryside_stewardship_grant",
                        "dfid_research_output",
                        "drug_safety_update",
                        "employment_appeal_tribunal_decision",
                        "employment_tribunal_decision",
                        "european_structural_investment_fund",
                        "international_development_fund",
                        "maib_report",
                        "medical_safety_alert",
                        "raib_report",
                        "residential_property_tribunal_decision",
                        "service_standard_report",
                        "tax_tribunal_decision",
                        "utaac_decision",
                        "calendar",
                        "finder",
                        "hmrc_manual",
                        "hmrc_manual_section",
                        "manual",
                        "manual_section",
                        "policy",
                        "recommended-link",
                        "service_manual_guide",
                        "service_manual_homepage",
                        "service_manual_service_standard",
                        "service_manual_topic",
                        "statutory_instrument",
                        "step_by_step_nav",
                        "task_list",
                        "taxon",
                        "travel_advice",
                        "travel_advice_index",
                        "special_route"
                     ]
                  }
               }
            }
         },
         "no_match_filter":{
            "bool":{
               "should":[
                  {
                     "bool":{
                        "must_not":{
                           "term":{
                              "is_withdrawn":true
                           }
                        }
                     }
                  }
               ],
               "must":{
                  "terms":{
                     "format":[
                        "mainstream_browse_page",
                        "specialist_sector",
                        "contact",
                        "answer",
                        "guide",
                        "help_page",
                        "licence",
                        "local_transaction",
                        "place",
                        "transaction",
                        "simple_smart_answer",
                        "aaib_report",
                        "asylum_support_decision",
                        "business_finance_support_scheme",
                        "cma_case",
                        "countryside_stewardship_grant",
                        "dfid_research_output",
                        "drug_safety_update",
                        "employment_appeal_tribunal_decision",
                        "employment_tribunal_decision",
                        "european_structural_investment_fund",
                        "international_development_fund",
                        "maib_report",
                        "medical_safety_alert",
                        "raib_report",
                        "residential_property_tribunal_decision",
                        "service_standard_report",
                        "tax_tribunal_decision",
                        "utaac_decision",
                        "calendar",
                        "finder",
                        "hmrc_manual",
                        "hmrc_manual_section",
                        "manual",
                        "manual_section",
                        "policy",
                        "recommended-link",
                        "service_manual_guide",
                        "service_manual_homepage",
                        "service_manual_service_standard",
                        "service_manual_topic",
                        "statutory_instrument",
                        "step_by_step_nav",
                        "task_list",
                        "taxon",
                        "travel_advice",
                        "travel_advice_index",
                        "special_route"
                     ]
                  }
               }
            }
         }
      }
   }
}
```

## Setup

These instructions assume you have a [GOV.UK development VM](https://docs.publishing.service.gov.uk/manual/get-started.html) running Elasticsearch
1.7. This is a very old of version, so some of the queries will be a bit different on a modern Elasticsearch cluster.

If you don't have access to GOV.UK data then you'll need to create your own Elasticsearch index and adapt the examples. Skip the sections that talk about custom analyzers as these are specfic to GOV.UK's configuration.

### Install the unofficial Sense browser plugin

**Note:** if you're using a modern version of elasticsearch, you should use the [Kibana console](https://www.elastic.co/guide/en/kibana/current/console-kibana.html) instead of installing a plugin.

The [sense plugin](https://chrome.google.com/webstore/detail/sense-beta/lhjgkmllcaadmopgmanpapmpjgmfcfig?hl=en) gives you a nice interactive environment for testing queries.

You should see a simple starting query:

```
GET _search
{
   "query": {
      "match_all": {}
   }
}
```

Set the server to `dev.gov.uk:9200` and press the play button to send the query.

Ignore any warnings about GET requests not being supported.

## Exercises

- [Query the content indexes](01_query_content_indexes.md)
- [Match a single field](02_match_single_field.md)
- [Debug analysis](03_debug_analysis.md)
- [Match multiple fields](04_match_multiple.md)
- [Match multiple terms](05_match_phrases.md)
- [Combine queries](06_combining_queries.md)
- Aggregate documents
